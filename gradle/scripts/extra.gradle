// You may write any gradle buildscript component in this file
// This file is automatically applied after build.gradle + dependencies.gradle is ran

// If you wish to use the default helper methods, uncomment the line below
// apply from: 'gradle/scripts/helpers.gradle'

/* Eclipse-related setup */

apply plugin: 'eclipse'

// Configure Eclipse to prevent indexing build folder
// This ensures that when Gradle generates .classpath, it excludes build/sources directories
eclipse {
    classpath {
        file {
            whenMerged { classpath ->
                // Remove any source entries that point to build/sources directories
                // These are generated by ForgeGradle but should not be indexed as source
                classpath.entries.removeAll { entry ->
                    entry.kind == 'src' && (
                            entry.path.startsWith('build/sources') ||
                                    entry.path == 'build' ||
                                    entry.path.startsWith('build/')
                    )
                }

                // Remove duplicate source entries (keep the first occurrence, typically the Gradle-generated one)
                def seenPaths = new HashSet()
                def entriesToRemove = []
                classpath.entries.each { entry ->
                    if (entry.kind == 'src' && entry.path) {
                        if (seenPaths.contains(entry.path)) {
                            entriesToRemove.add(entry)
                        } else {
                            seenPaths.add(entry.path)
                        }
                    }
                }
                classpath.entries.removeAll(entriesToRemove)
            }
        }
    }
}

// Task to fix .project file after eclipse generation
// This adds build folder exclusion to prevent IDE indexing
tasks.register('fixEclipseProject') {
    description = 'Fixes .project file to exclude build folder from Eclipse indexing'
    doLast {
        def projectFile = file('.project')
        if (!projectFile.exists()) {
            logger.warn('.project file not found. Run gradlew eclipse first.')
            return
        }

        def content = projectFile.getText('UTF-8')

        // Check if build folder filter already exists
        if (content.contains('^build/')) {
            logger.info('.project file already has build folder exclusion')
            return
        }

        // Add build folder filter before closing filteredResources tag
        def filterPattern = '''\t\t<filter>
			<id>2</id>
			<type>30</type>
			<name/>
			<matcher>
				<id>org.eclipse.core.resources.regexFilterMatcher</id>
				<arguments>^build/</arguments>
			</matcher>
		</filter>
	</filteredResources>'''

        content = content.replace('</filteredResources>', filterPattern)
        projectFile.setText(content, 'UTF-8')
        logger.info('Fixed .project file - build folder will be excluded from indexing')
    }
}

tasks.withType(Copy).configureEach {
    duplicatesStrategy = DuplicatesStrategy.INCLUDE
}

// Task to clean Eclipse metadata files
tasks.register('cleanEclipseMetadata') {
    description = 'Removes Eclipse metadata files (.classpath, .project, .settings)'
    doLast {
        delete '.classpath'
        delete '.project'
        delete '.settings'
        logger.info('Cleaned Eclipse metadata files')
    }
}

// Make fixEclipseProject run after eclipse task
tasks.eclipse.finalizedBy fixEclipseProject

// Make eclipse task depend on cleaning metadata to prevent duplicates
tasks.eclipse.dependsOn cleanEclipseMetadata